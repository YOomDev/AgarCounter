<html>
	<head>
		<title>Agar Counter - v0.1 Ype Oomes</title>
		<style>
			div {
				width: 100%;
			}
		</style>
	</head>
	<body>
		<device type="media" onchange="update(this.data)" style="display: none;"></device>
		<div>
			<video autoplay>
		</div>
		<div>
			<canvas width="320" id="unfiltered" height="240" onclick="set()"></canvas>
			<canvas width="320" id="filtered" height="240"></canvas>
			<canvas width="320" id="result" height="240"></canvas>
		</div>
		<div>
			<button type="button" onclick="log()">Test</button>
			<button type="button" onclick="set_p = 0">Set agar mask color</button>
			<button type="button" onclick="set_p = 1">Set Colony mask color</button>
		</div>
		
		
		</video>
		<script>
			// Function pointer to fix problems between browsers
			navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;

			const video = document.querySelector('video'); // Video element
			const c0 = document.querySelector('#unfiltered'); // Unfiltered canvas
			const c0c = c0.getContext("2d"); // Drawing context for rendering to the unfiltered cavas
			const c1 = document.querySelector('#filtered'); // Filtered canvas
			const c1c = c1.getContext("2d"); // Drawing context for rendering to the filtered cavas
			const c2 = document.querySelector('#result');
			const c2c = c2.getContext("2d");
			let set_p = -1;
			let agarPos = { x: 0, y: 0 };
			let colonyPos = { x: 0, y: 0 };
			let agarMask = { r: 0, g: 0, b: 0, a: 0 };
			let colonyMask = { r: 0, g: 0, b: 0, a: 0 };

			c0.addEventListener('click', e => {
				if (set_p == -1) { return; }
				let rect = c0.getBoundingClientRect(); // used for getting the offset from the canvas
				if (set_p == 0) { agarPos = { x: e.clientX - rect.left, y: e.clientY - rect.top }; }
				if (set_p == 1) { colonyPos = { x: e.clientX - rect.left, y: e.clientY - rect.top }; }
				set_p = -1;
			});

			function set() {
				
			}

			function log() {
				console.log(agarMask);
				console.log(colonyMask);
			}

			if (navigator.mediaDevices.getUserMedia) {
				navigator.mediaDevices.getUserMedia({ video: true })
					.then(function (stream) {
						video.srcObject = stream;

						c0.width = stream.getVideoTracks()[0].getSettings().width;
						c0.height = stream.getVideoTracks()[0].getSettings().height;
						c1.width = c0.width;
						c1.height = c0.height;
						c2.width = c1.width;
						c2.height = c1.height;
					})
					.catch(function (e) {
						console.log("Something went wrong: " + e);
					});

				update();
				setInterval(update, 100);
			}

			function update() {
				// Copy image from webcam to all the canvases
				c0c.drawImage(video, 0, 0);
				const imageData = c0c.getImageData(0, 0, c0.width, c0.height);
				let raw = imageData.data;
				c1c.putImageData(imageData, 0, 0);
				c2c.putImageData(imageData, 0, 0);

				mask(); // Create mask image
				count();
			}

			function mask() {
				const raw = c0c.getImageData(0, 0, c0.width, c0.height).data;
				const agarIdx = (agarPos.y * c0.width + agarPos.x) * 4;
				const colonyIdx = (colonyPos.y * c0.width + agarPos.x) * 4;
				agarMask = { r: raw[agarIdx], g: raw[agarIdx + 1], b: raw[agarIdx + 2], a: raw[agarIdx + 3] };
				colonyMask = { r: raw[colonyIdx], g: raw[colonyIdx + 1], b: raw[colonyIdx + 2], a: raw[colonyIdx + 3] };
			}

			function count() {

			}
		</script>
	</body>
</html>